# Инструкция по тестированию исправлений

## Внесенные изменения

### 1. **SystemBlockAccessibilityService** 
- Добавлена полная обработка комбинаций клавиш через `onKeyEvent()`
- Теперь сервис отслеживает нажатия Volume Up, Volume Down и Power
- Поддерживает все типы комбинаций: одновременные нажатия и долгие нажатия
- При обнаружении комбинации отправляет broadcast для переключения видимости

### 2. **KeyCombinationReceiver**
- Новый BroadcastReceiver для обработки событий комбинаций клавиш
- Получает уведомления от AccessibilityService
- Переключает видимость приложений и управляет TouchBlockService

### 3. **TouchBlockService**
- Добавлены флаги для работы на экране блокировки:
  - `FLAG_SHOW_WHEN_LOCKED` - показывать поверх экрана блокировки
  - `FLAG_DISMISS_KEYGUARD` - разблокировать экран
  - `FLAG_TURN_SCREEN_ON` - включать экран
  - `FLAG_KEEP_SCREEN_ON` - держать экран включенным
- Изменен приоритет уведомления на HIGH для работы на экране блокировки

### 4. **MainActivity**
- Добавлена регистрация BroadcastReceiver для обновления UI после изменения видимости

## Как тестировать

### Предварительная настройка:
1. Соберите и установите приложение
2. Установите лаунчер как домашний экран по умолчанию
3. Перейдите в настройки Android → Специальные возможности
4. Найдите "System Block Service" и включите его
5. Предоставьте разрешение на отображение поверх других приложений
6. В настройках лаунчера выберите комбинацию клавиш для переключения

### Тестовые сценарии:

#### Сценарий 1: Базовая функциональность
1. На главном экране нажмите выбранную комбинацию клавиш
2. Убедитесь, что приложения скрываются и экран блокируется
3. Нажмите комбинацию снова - приложения должны появиться

#### Сценарий 2: Работа на заблокированном экране
1. Активируйте скрытый режим (приложения скрыты, экран заблокирован)
2. Нажмите кнопку питания, чтобы выключить экран
3. Нажмите кнопку питания снова, чтобы включить экран
4. **На экране блокировки** нажмите настроенную комбинацию клавиш
5. Экран должен разблокироваться и показать приложения

#### Сценарий 3: Различные комбинации
Протестируйте каждую комбинацию:
- **Обе кнопки громкости** - нажмите одновременно Vol Up + Vol Down
- **Power + Vol Up** - нажмите одновременно
- **Power + Vol Down** - нажмите одновременно  
- **Долгое нажатие Vol Up** - удерживайте 1 секунду
- **Долгое нажатие Vol Down** - удерживайте 1 секунду
- **Долгое нажатие Power** - удерживайте 1 секунду

#### Сценарий 4: Проверка блокировки
1. В скрытом режиме попробуйте:
   - Свайп вниз для панели уведомлений - должен быть заблокирован
   - Свайп вверх для недавних приложений - должен быть заблокирован
   - Нажатие кнопок Home/Back - должны быть заблокированы
   - Касания экрана - должны быть заблокированы

## Логирование для отладки

Используйте ADB для просмотра логов:
```bash
adb logcat | grep -E "SystemBlockService|TouchBlockService|KeyCombinationReceiver|MainActivity"
```

Ключевые сообщения в логах:
- `"KeyEvent: action=..."` - регистрация нажатий клавиш
- `"Both volume buttons detected!"` - обнаружена комбинация
- `"Toggling apps visibility from AccessibilityService"` - переключение видимости
- `"Key combination detected via broadcast"` - получен broadcast
- `"Apps hidden, touch blocked"` / `"Apps shown, touch unblocked"` - изменение состояния

## Возможные проблемы и решения

### Проблема: Комбинация не работает на экране блокировки
**Решение:** Убедитесь, что AccessibilityService включен и имеет все необходимые разрешения

### Проблема: Экран не разблокируется
**Решение:** Проверьте, что в настройках безопасности Android разрешена разблокировка через accessibility

### Проблема: Клавиши не регистрируются
**Решение:** Перезапустите AccessibilityService через настройки Android

## Дополнительные проверки

1. **Перезагрузка устройства** - убедитесь, что сервисы запускаются автоматически
2. **Режим "Не беспокоить"** - проверьте работу в этом режиме
3. **Разные версии Android** - протестируйте на Android 11, 12, 13, 14

## Контрольный список
- [ ] AccessibilityService включен
- [ ] Разрешение на наложение предоставлено
- [ ] Комбинация клавиш настроена
- [ ] Работает переключение на главном экране
- [ ] Работает переключение на экране блокировки
- [ ] Все типы комбинаций работают
- [ ] Блокировка касаний работает
- [ ] Логи показывают корректную работу
